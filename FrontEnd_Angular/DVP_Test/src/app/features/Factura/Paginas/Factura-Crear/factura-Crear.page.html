<h2 class="mb-3 text-primary fw-bold">Nueva Factura</h2>

<form
  [formGroup]="form"
  (ngSubmit)="guardar()"
  class="p-3 border rounded shadow-sm bg-light"
>
  <div class="mb-3 d-flex justify-content-between align-items-center">
    <label class="form-label fw-semibold mb-0">Número de Factura</label>
    <button type="button" class="btn btn-outline-secondary btn-sm" (click)="nuevo()">Nuevo</button>
  </div>
  <input
    class="form-control"
    formControlName="numeroFactura"
    placeholder="Ej: 1001"
  />

  <div class="mb-3">
    <label class="form-label fw-semibold">Cliente</label>
    <select class="form-select" formControlName="clienteId">
      <option value="">Seleccione...</option>
      @for (c of clientes(); track c.clienteId) {
      <option [value]="c.clienteId">
        {{ c.nombre }}
      </option>
      }
    </select>
  </div>

  <div class="mb-4">
    <label class="form-label fw-semibold">Agregar Producto</label>
    <select class="form-select" (change)="agregarLinea($event)">
      <option value="">Seleccione...</option>
      @for (p of productosCombo(); track p.productoId) {
      <option [value]="p.productoId">
        {{ p.nombre }}
      </option>
      }
    </select>
  </div>

  <table
    class="table table-sm table-bordered table-hover align-middle"
    *ngIf="detalles().length > 0"
  >
    <thead class="table-light">
      <tr>
        <th>Producto</th>
        <th>Nombre</th>
        <th>Imagen</th>
        <th>Cantidad</th>
        <th>Precio</th>
        <th>Total</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      @for (l of detallesConInfo(); track l.productoId) {
      <tr>
        <td>{{ l.productoId }}</td>
        <td>{{ l.nombre }}</td>
        <td> <img [src]="l.imagen" alt="{{ l.nombre }}" width="50" height="50"></td>
        <td>
          <input
            type="number"
            class="form-control form-control-sm"
            [value]="l.cantidad"
            (input)="actualizarCantidad(l, $any($event.target).value)"
            min="1"
          />
        </td>
        <td class="text-end">{{ l.precioUnitario | currency }}</td>
        <td class="text-end fw-semibold">{{ l.totalLinea | currency }}</td>
        <td class="text-center">
          <button
            type="button"
            class="btn btn-outline-danger btn-sm"
            (click)="eliminarLinea(l.productoId)"
          >
            ✕
          </button>
        </td>
      </tr>
      }
    </tbody>
  </table>

  <div class="mt-3 p-3 bg-white border rounded">
    <p class="mb-1">
      Subtotal: <span class="fw-medium">{{ subtotal() | currency }}</span>
    </p>
    <p class="mb-1">
      Impuestos: <span class="fw-medium">{{ impuestos() | currency }}</span>
    </p>
    <p class="mb-0 fw-bold">Total: {{ total() | currency }}</p>
  </div>

  @if (error()) {
  <div class="alert alert-danger mt-3">
    {{ error() }}
  </div>
  }

  <button type="submit" class="btn btn-primary mt-3">Guardar</button>
</form>
